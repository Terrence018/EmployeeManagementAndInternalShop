<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.empmall.mapper.EmpMapper">

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO emp(
            username, name, gender, image, job, entry_date,
            dept_id, create_time, update_time, email, phone, salary
        ) VALUES (
                     #{username}, #{name}, #{gender}, #{image}, #{job}, #{entryDate},
                     #{deptId}, #{createTime}, #{updateTime}, #{email}, #{phone}, #{salary}
                 )
    </insert>

    <update id="updateById">
        UPDATE emp
        <set>
            <if test="username != null and username != ''"> username = #{username}, </if>
            <if test="password != null and password != ''"> password = #{password}, </if>
            <if test="name != null and name != ''"> name = #{name}, </if>
            <if test="gender != null"> gender = #{gender}, </if>
            <if test="phone != null and phone != ''"> phone = #{phone}, </if>
            <if test="job != null"> job = #{job}, </if>
            <if test="salary != null"> salary = #{salary}, </if>
            <if test="image != null and image != ''"> image = #{image}, </if>
            <if test="entryDate != null"> entry_date = #{entryDate}, </if>
            <if test="deptId != null"> dept_id = #{deptId}, </if>
            <if test="updateTime != null"> update_time = #{updateTime}, </if>
            <if test="email != null and email != ''"> email = #{email}, </if>
        </set>
        WHERE id = #{id}
    </update>

    <update id="deleteByIds">
        UPDATE emp
        SET status = 0,
        update_time = now()
        WHERE id IN
        <foreach collection="ids" item="id" separator="," open="(" close=")">
            #{id}
        </foreach>
    </update>

    <select id="list" resultMap="empResultMap">
        select e.*, d.name deptName from emp e left join dept d on e.dept_id =d.id
        <where>
            e.status = 1

            <if test="name != null and name != ''">
                and e.name like concat('%',#{name},'%')
            </if>
            <if test="gender != null">
                and e.gender = #{gender}
            </if>
            <if test="begin != null and end != null">
                and e.entry_date between #{begin} and #{end}
            </if>
        </where>
        order by e.update_time desc
    </select>

    <resultMap id="empResultMap" type="com.empmall.pojo.Emp">
        <id column="id" property="id"/>
        <result column="username" property="username"/>
        <result column="password" property="password"/>
        <result column="name" property="name"/>
        <result column="gender" property="gender"/>
        <result column="phone" property="phone"/>
        <result column="job" property="job"/>
        <result column="salary" property="salary"/>
        <result column="image" property="image"/>
        <result column="entry_date" property="entryDate"/>
        <result column="dept_id" property="deptId"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>

        <result column="deptName" property="deptName"/>

        <result column="points" property="points"/>
        <result column="email" property="email"/>

        <collection property="exprList" ofType="com.empmall.pojo.EmpExpr">
            <id column="ee_id" property="id"/>
            <result column="ee_empid" property="empId"/>
            <result column="ee_begin" property="begin"/>
            <result column="ee_end" property="end"/>
            <result column="ee_company" property="company"/>
            <result column="ee_job" property="job"/>
        </collection>
    </resultMap>

    <select id="getById" resultMap="empResultMap">
        select
            e.*,
            ee.id ee_id,
            ee.emp_id ee_empid,
            ee.begin ee_begin,
            ee.end ee_end,
            ee.company ee_company,
            ee.job ee_job
        from emp e left join emp_expr ee on e.id = ee.emp_id
        where e.id = #{id};
    </select>

    <select id="countEmpJobData" resultType="java.util.Map">
        select
            (case when job=1 then '人力部'
                  when job=2 then '資訊部'
                  when job=3 then '勒布朗詹姆斯'
                  when job=4 then '教研主管'
                  when job=5 then '咨詢師'
                  else '其他' end) pos ,
            count(*) num
        from emp group by job order by num
    </select>

    <select id="getEmpGenderData" resultType="java.util.Map">
        select
            if(gender = 1, '男性員工', '女性員工') name,
            count(*) value
        from emp group by gender;
    </select>

    <update id="updatePersonal">
        UPDATE emp
        <set>
            <if test="phone != null and phone != ''"> phone = #{phone}, </if>
            <if test="password != null and password != ''"> password = #{password}, </if>
            <if test="email != null and email != ''"> email = #{email}, </if>
            <if test="updateTime != null"> update_time = #{updateTime}, </if>
        </set>
        WHERE id = #{id}
    </update>


    <select id="selectBatchIds" resultMap="empResultMap">
        select * from emp where id in
        <foreach collection="ids" item="id" separator="," open="(" close=")">
            #{id}
        </foreach>
    </select>

    <select id="countBySalary" resultType="com.empmall.pojo.EmpReportVO">
        SELECT
            CASE
                WHEN salary &lt; 35000 THEN '3.5萬以下'
                WHEN salary &gt;= 35000 AND salary &lt;= 50000 THEN '3.5萬-5萬'
                WHEN salary &gt; 50000 AND salary &lt;= 70000 THEN '5萬-7萬'
                WHEN salary &gt; 70000 THEN '7萬以上'
                ELSE '未紀錄'
                END AS categoryName,
            COUNT(*) AS count
        FROM emp
        GROUP BY categoryName
    </select>

</mapper>